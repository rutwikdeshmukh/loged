#!/bin/bash

set -e

RUNTIME_DIR="runtime"
PIDFILE="$RUNTIME_DIR/catlog.pid"
LOGFILE="$RUNTIME_DIR/catlog.log"
BINARY="$RUNTIME_DIR/catlog-server"

# Function to install and build
install_and_build() {
    echo "ğŸš€ Catlog - Lightweight Log Viewer Setup"
    echo "======================================="

    # Create runtime directory
    mkdir -p "$RUNTIME_DIR"

    # Check what needs to be installed (Linux only - nginx not installed on Windows/macOS)
    NEED_GO=false
    NEED_NGINX=false
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if ! command -v go &> /dev/null; then
            NEED_GO=true
        fi
        if ! command -v nginx &> /dev/null; then
            NEED_NGINX=true
        fi
        
        # Install packages if needed
        if [[ "$NEED_GO" == true ]] || [[ "$NEED_NGINX" == true ]]; then
            echo "ğŸ“¦ Installing packages..."
            
            if command -v apt-get &> /dev/null; then
                sudo apt-get update -qq
                if [[ "$NEED_GO" == true ]]; then
                    sudo apt-get install -y golang-go
                fi
                if [[ "$NEED_NGINX" == true ]]; then
                    sudo apt-get install -y nginx
                fi
            elif command -v yum &> /dev/null; then
                if [[ "$NEED_GO" == true ]]; then
                    sudo yum install -y golang
                fi
                if [[ "$NEED_NGINX" == true ]]; then
                    sudo yum install -y nginx
                fi
            elif command -v dnf &> /dev/null; then
                if [[ "$NEED_GO" == true ]]; then
                    sudo dnf install -y golang
                fi
                if [[ "$NEED_NGINX" == true ]]; then
                    sudo dnf install -y nginx
                fi
            else
                echo "âŒ Unsupported Linux distribution. Please install Go and nginx manually."
                exit 1
            fi
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        if ! command -v go &> /dev/null; then
            echo "ğŸ“¦ Installing Go..."
            if command -v brew &> /dev/null; then
                brew install go
            else
                echo "âŒ Please install Homebrew first or install Go manually from https://golang.org/dl/"
                exit 1
            fi
        fi
    else
        if ! command -v go &> /dev/null; then
            echo "âŒ Unsupported OS. Please install Go manually from https://golang.org/dl/"
            exit 1
        fi
    fi

    if command -v go &> /dev/null; then
        echo "âœ… Go is installed: $(go version)"
    fi

    # Install dependencies
    echo "ğŸ“¦ Installing dependencies..."
    cd src && go mod tidy && cd ..

    # Build the application
    echo "ğŸ”¨ Building catlog..."
    cd src && go build -o "../$BINARY" main.go && cd ..

    # Make it executable
    chmod +x "$BINARY"

    # Setup nginx reverse proxy (Linux only)
    if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v nginx &> /dev/null; then
        echo "ğŸŒ Setting up nginx reverse proxy..."
        
        # Set timezone to IST for consistent logging
        echo "ğŸ• Setting timezone to IST..."
        sudo timedatectl set-timezone Asia/Kolkata 2>/dev/null || echo "âš ï¸  Could not set timezone automatically"
        
        # Get public IP dynamically
        PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com || echo "127.0.0.1")
        echo "ğŸ“ Detected public IP: $PUBLIC_IP"
        
        # Update config.yml with detected IP
        if [ -f "config.yml" ]; then
            sed -i "s/server_ip: .*/server_ip: \"$PUBLIC_IP\"/" config.yml
            echo "âœ… Updated config.yml with server IP"
        fi
        
        # Generate SSL certificate if it doesn't exist
        SSL_GENERATED=false
        if [ ! -f "/etc/ssl/certs/catlog.crt" ]; then
            echo "ğŸ”’ Generating SSL certificate..."
            sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout /etc/ssl/private/catlog.key \
                -out /etc/ssl/certs/catlog.crt \
                -subj "/C=US/ST=State/L=City/O=Catlog/CN=$PUBLIC_IP" 2>/dev/null
            
            sudo chmod 600 /etc/ssl/private/catlog.key
            sudo chmod 644 /etc/ssl/certs/catlog.crt
            SSL_GENERATED=true
            echo "âœ… SSL certificate generated"
        else
            echo "âœ… SSL certificate already exists"
        fi
        
        # Create nginx config with dynamic IP
        sed "s/SERVER_IP/$PUBLIC_IP/g" catlog-nginx > /tmp/catlog-nginx-configured
        sudo cp /tmp/catlog-nginx-configured /etc/nginx/sites-available/catlog
        rm /tmp/catlog-nginx-configured
        
        sudo ln -sf /etc/nginx/sites-available/catlog /etc/nginx/sites-enabled/catlog
        
        # Restart nginx only if SSL was newly generated, otherwise just reload
        if [ "$SSL_GENERATED" = true ]; then
            sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload 2>/dev/null || echo "âš ï¸  Please restart nginx manually"
        else
            sudo nginx -s reload 2>/dev/null || sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Please reload nginx manually"
        fi
        echo "âœ… Nginx reverse proxy configured with SSL"
        echo "ğŸ“ Access via: https://$PUBLIC_IP/catlog"
        echo "âš ï¸  Browser will show security warning - click 'Advanced' â†’ 'Proceed'"
    fi

    # Setup auto-start on boot (Linux only)
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "â° Setting up auto-start on boot..."
        CURRENT_DIR=$(pwd)
        
        # Check if crontab entry already exists
        if ! crontab -l 2>/dev/null | grep -q "catlog restart"; then
            # Add crontab entry for auto-start (handle empty crontab)
            { crontab -l 2>/dev/null || true; echo "@reboot sleep 60 && cd $CURRENT_DIR && ./catlog restart"; } | crontab -
            echo "âœ… Auto-start configured - catlog will restart automatically on server reboot"
        else
            echo "âœ… Auto-start already configured"
        fi
    fi

    echo "âœ… Catlog installed successfully!"
}

case "$1" in
    start)
        # Check if config.yml exists
        if [ ! -f "config.yml" ]; then
            echo "âŒ Error: config.yml not found"
            echo "ğŸ“ Please copy example.config.yml to config.yml and configure it"
            echo "   cp example.config.yml config.yml"
            exit 1
        fi
        
        # Build if binary doesn't exist
        if [ ! -f "$BINARY" ]; then
            install_and_build
        fi
        
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "Catlog is already running (PID: $PID)"
                echo "Access at: http://localhost:8008"
                exit 1
            else
                rm -f "$PIDFILE"
            fi
        fi
        
        echo "ğŸ‰ Starting Catlog server..."
        nohup "./$BINARY" > "$LOGFILE" 2>&1 &
        PID=$!
        echo $PID > "$PIDFILE"
        
        sleep 1
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "âœ… Catlog started successfully (PID: $PID)"
            echo "ğŸ“ Server available at: http://localhost:8008"
            echo "ğŸ“„ Configuration loaded from config.yml"
        else
            echo "âŒ Failed to start Catlog"
            rm -f "$PIDFILE"
            exit 1
        fi
        ;;
    
    stop)
        echo "ğŸ›‘ Stopping Catlog..."
        
        # Kill by PID file first
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                kill -TERM "$PID" 2>/dev/null || true
                sleep 2
                # Force kill if still running
                if ps -p "$PID" > /dev/null 2>&1; then
                    kill -KILL "$PID" 2>/dev/null || true
                fi
            fi
            rm -f "$PIDFILE"
        fi
        
        # Kill any remaining catlog-server processes by name
        pkill -f "catlog-server" 2>/dev/null || true
        sleep 1
        
        # Force kill any stubborn processes
        pkill -9 -f "catlog-server" 2>/dev/null || true
        
        # Kill any process using port 8008
        lsof -ti:8008 2>/dev/null | xargs kill -9 2>/dev/null || true
        
        echo "âœ… Catlog stopped"
        ;;
    
    status)
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "âœ… Catlog is running (PID: $PID)"
                echo "ğŸ“ Access at: http://localhost:8008"
            else
                echo "âŒ Catlog is not running"
                rm -f "$PIDFILE"
            fi
        else
            echo "âŒ Catlog is not running"
        fi
        ;;
    
    restart)
        # Check if config.yml exists
        if [ ! -f "config.yml" ]; then
            echo "âŒ Error: config.yml not found"
            echo "ğŸ“ Please copy example.config.yml to config.yml and configure it"
            echo "   cp example.config.yml config.yml"
            exit 1
        fi
        
        echo "ğŸ”„ Restarting Catlog with IP detection..."
        
        # Stop current service
        $0 stop
        
        # Detect current IP
        echo "ğŸŒ Detecting public IP..."
        NEW_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com || echo "127.0.0.1")
        echo "ğŸ“ Current IP: $NEW_IP"
        
        # Update config.yml with new IP
        if [ -f "config.yml" ]; then
            sed -i "s/server_ip: .*/server_ip: \"$NEW_IP\"/" config.yml
            echo "âœ… Updated config.yml with new IP"
        fi
        
        # Linux-specific SSL and nginx updates
        if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v nginx &> /dev/null; then
            # Regenerate SSL certificates
            echo "ğŸ”’ Regenerating SSL certificates..."
            sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout /etc/ssl/private/catlog.key \
                -out /etc/ssl/certs/catlog.crt \
                -subj "/C=US/ST=State/L=City/O=Catlog/CN=$NEW_IP" 2>/dev/null
            
            sudo chmod 600 /etc/ssl/private/catlog.key
            sudo chmod 644 /etc/ssl/certs/catlog.crt
            echo "âœ… SSL certificates regenerated"
            
            # Update nginx config
            echo "ğŸŒ Updating nginx configuration..."
            sed "s/SERVER_IP/$NEW_IP/g" catlog-nginx > /tmp/catlog-nginx-configured
            sudo cp /tmp/catlog-nginx-configured /etc/nginx/sites-available/catlog
            rm /tmp/catlog-nginx-configured
            
            # Ensure nginx site is enabled
            sudo ln -sf /etc/nginx/sites-available/catlog /etc/nginx/sites-enabled/catlog
            
            # Reload nginx
            sudo nginx -s reload 2>/dev/null || sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Please reload nginx manually"
            echo "âœ… Nginx updated and reloaded"
        fi
        
        # Start catlog
        echo "ğŸš€ Starting Catlog..."
        $0 start
        
        echo ""
        echo "ğŸ‰ Catlog restarted successfully!"
        echo "ğŸ“ Access via: https://$NEW_IP/login"
        echo "ğŸ“ Or via HTTP: http://$NEW_IP/login"
        ;;
    
    update)
        echo "ğŸ”„ Updating Catlog..."
        
        # Force stop any running instances
        echo "ğŸ›‘ Stopping any running instances..."
        $0 stop
        
        # Extra cleanup - kill anything on port 8008
        lsof -ti:8008 2>/dev/null | xargs kill -9 2>/dev/null || true
        
        sleep 2
        install_and_build
        
        # Always update nginx config if on Linux
        if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v nginx &> /dev/null; then
            echo "ğŸŒ Updating nginx configuration..."
            
            # Set timezone to IST for consistent logging
            echo "ğŸ• Setting timezone to IST..."
            sudo timedatectl set-timezone Asia/Kolkata 2>/dev/null || echo "âš ï¸  Could not set timezone automatically"
            
            # Get public IP dynamically
            PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com || echo "127.0.0.1")
            
            # Create nginx config with dynamic IP
            sed "s/SERVER_IP/$PUBLIC_IP/g" catlog-nginx > /tmp/catlog-nginx-configured
            sudo cp /tmp/catlog-nginx-configured /etc/nginx/sites-available/catlog
            rm /tmp/catlog-nginx-configured
            
            if [ ! -L /etc/nginx/sites-enabled/catlog ]; then
                sudo ln -s /etc/nginx/sites-available/catlog /etc/nginx/sites-enabled/catlog
            fi
            sudo nginx -s reload 2>/dev/null || sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Please reload nginx manually"
            echo "âœ… Nginx configuration updated"
        fi
        
        echo ""
        echo "ğŸš€ Starting updated server..."
        $0 start
        ;;
    
    uninstall)
        echo "ğŸ—‘ï¸ Uninstalling Catlog..."
        
        # Stop server if running
        $0 stop 2>/dev/null || true
        
        # Remove nginx configuration
        if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v nginx &> /dev/null; then
            echo "ğŸŒ Removing nginx configuration..."
            sudo rm -f /etc/nginx/sites-enabled/catlog
            sudo rm -f /etc/nginx/sites-available/catlog
            sudo nginx -s reload 2>/dev/null || sudo systemctl reload nginx 2>/dev/null || true
        fi
        
        # Remove SSL certificates
        echo "ğŸ”’ Removing SSL certificates..."
        sudo rm -f /etc/ssl/certs/catlog.crt
        sudo rm -f /etc/ssl/private/catlog.key
        
        # Remove auto-start crontab entry (Linux only)
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            echo "â° Removing auto-start configuration..."
            if crontab -l 2>/dev/null | grep -q "catlog restart"; then
                { crontab -l 2>/dev/null || true; } | grep -v "catlog restart" | crontab -
                echo "âœ… Auto-start configuration removed"
            fi
        fi
        
        # Remove runtime directory
        echo "ğŸ“ Removing runtime files..."
        rm -rf runtime/
        
        # Remove built binary
        rm -f catlog-server
        
        # Remove log and pid files
        rm -f catlog.log catlog.pid
        
        echo "âœ… Catlog uninstalled successfully"
        echo "ğŸ“ Note: Go and nginx packages were not removed"
        echo "ğŸ“ Note: config.yml was preserved"
        ;;
    
    ""|install)
        install_and_build
        echo ""
        echo "ğŸ‰ Installation complete!"
        echo "ğŸ“ Run 'catlog start' to start the server"
        echo "ğŸ“ Run 'catlog stop' to stop the server"
        ;;
    
    *)
        echo "Usage: catlog {start|stop|status|install|update|restart|uninstall}"
        echo ""
        echo "Commands:"
        echo "  start     - Start Catlog server in background"
        echo "  stop      - Stop Catlog server"
        echo "  status    - Check if Catlog is running"
        echo "  install   - Install dependencies and build"
        echo "  update    - Stop, rebuild, and restart server"
        echo "  restart   - Restart with IP detection and SSL regeneration"
        echo "  uninstall - Remove all catlog files and configurations"
        exit 1
        ;;
esac
