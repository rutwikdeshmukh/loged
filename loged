#!/bin/bash

set -e

RUNTIME_DIR="runtime"
PIDFILE="$RUNTIME_DIR/loged.pid"
LOGFILE="$RUNTIME_DIR/loged.log"
BINARY="$RUNTIME_DIR/loged-server"

# Function to install and build
install_and_build() {
    echo "ğŸš€ Loged - Lightweight Log Viewer Setup"
    echo "======================================="

    # Create runtime directory
    mkdir -p "$RUNTIME_DIR"

    # Check what needs to be installed (Linux only - nginx not installed on Windows/macOS)
    NEED_GO=false
    NEED_NGINX=false
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if ! command -v go &> /dev/null; then
            NEED_GO=true
        fi
        if ! command -v nginx &> /dev/null; then
            NEED_NGINX=true
        fi
        
        # Install packages if needed
        if [[ "$NEED_GO" == true ]] || [[ "$NEED_NGINX" == true ]]; then
            echo "ğŸ“¦ Installing packages..."
            
            if command -v apt-get &> /dev/null; then
                sudo apt-get update -qq
                if [[ "$NEED_GO" == true ]]; then
                    sudo apt-get install -y golang-go
                fi
                if [[ "$NEED_NGINX" == true ]]; then
                    sudo apt-get install -y nginx
                fi
            elif command -v yum &> /dev/null; then
                if [[ "$NEED_GO" == true ]]; then
                    sudo yum install -y golang
                fi
                if [[ "$NEED_NGINX" == true ]]; then
                    sudo yum install -y nginx
                fi
            elif command -v dnf &> /dev/null; then
                if [[ "$NEED_GO" == true ]]; then
                    sudo dnf install -y golang
                fi
                if [[ "$NEED_NGINX" == true ]]; then
                    sudo dnf install -y nginx
                fi
            else
                echo "âŒ Unsupported Linux distribution. Please install Go and nginx manually."
                exit 1
            fi
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        if ! command -v go &> /dev/null; then
            echo "ğŸ“¦ Installing Go..."
            if command -v brew &> /dev/null; then
                brew install go
            else
                echo "âŒ Please install Homebrew first or install Go manually from https://golang.org/dl/"
                exit 1
            fi
        fi
    else
        if ! command -v go &> /dev/null; then
            echo "âŒ Unsupported OS. Please install Go manually from https://golang.org/dl/"
            exit 1
        fi
    fi

    if command -v go &> /dev/null; then
        echo "âœ… Go is installed: $(go version)"
    fi

    # Install dependencies
    echo "ğŸ“¦ Installing dependencies..."
    cd src && go mod tidy && cd ..

    # Build the application
    echo "ğŸ”¨ Building loged..."
    cd src && go build -o "../$BINARY" main.go && cd ..

    # Make it executable
    chmod +x "$BINARY"

    # Setup nginx reverse proxy (Linux only)
    if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v nginx &> /dev/null; then
        echo "ğŸŒ Setting up nginx reverse proxy..."
        
        # Get public IP dynamically
        PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com || echo "127.0.0.1")
        echo "ğŸ“ Detected public IP: $PUBLIC_IP"
        
        # Generate SSL certificate if it doesn't exist
        if [ ! -f "/etc/ssl/certs/loged.crt" ]; then
            echo "ğŸ”’ Generating SSL certificate..."
            sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout /etc/ssl/private/loged.key \
                -out /etc/ssl/certs/loged.crt \
                -subj "/C=US/ST=State/L=City/O=Loged/CN=$PUBLIC_IP" 2>/dev/null
            
            sudo chmod 600 /etc/ssl/private/loged.key
            sudo chmod 644 /etc/ssl/certs/loged.crt
            echo "âœ… SSL certificate generated"
        else
            echo "âœ… SSL certificate already exists"
        fi
        
        # Create nginx config with dynamic IP
        sed "s/SERVER_IP/$PUBLIC_IP/g" loged-nginx > /tmp/loged-nginx-configured
        sudo cp /tmp/loged-nginx-configured /etc/nginx/sites-available/loged
        rm /tmp/loged-nginx-configured
        
        sudo ln -sf /etc/nginx/sites-available/loged /etc/nginx/sites-enabled/loged
        sudo nginx -s reload 2>/dev/null || sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Please reload nginx manually"
        echo "âœ… Nginx reverse proxy configured with SSL"
        echo "ğŸ“ Access via: https://$PUBLIC_IP/loged"
        echo "âš ï¸  Browser will show security warning - click 'Advanced' â†’ 'Proceed'"
    fi

    echo "âœ… Loged installed successfully!"
}

case "$1" in
    start)
        # Build if binary doesn't exist
        if [ ! -f "$BINARY" ]; then
            install_and_build
        fi
        
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "Loged is already running (PID: $PID)"
                echo "Access at: http://localhost:8008"
                exit 1
            else
                rm -f "$PIDFILE"
            fi
        fi
        
        echo "ğŸ‰ Starting Loged server..."
        nohup "./$BINARY" > "$LOGFILE" 2>&1 &
        PID=$!
        echo $PID > "$PIDFILE"
        
        sleep 1
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "âœ… Loged started successfully (PID: $PID)"
            echo "ğŸ“ Server available at: http://localhost:8008"
            echo "ğŸ“„ Configuration loaded from config.yml"
        else
            echo "âŒ Failed to start Loged"
            rm -f "$PIDFILE"
            exit 1
        fi
        ;;
    
    stop)
        echo "ğŸ›‘ Stopping Loged..."
        
        # Kill by PID file first
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                kill -TERM "$PID" 2>/dev/null || true
                sleep 2
                # Force kill if still running
                if ps -p "$PID" > /dev/null 2>&1; then
                    kill -KILL "$PID" 2>/dev/null || true
                fi
            fi
            rm -f "$PIDFILE"
        fi
        
        # Kill any remaining loged-server processes by name
        pkill -f "loged-server" 2>/dev/null || true
        sleep 1
        
        # Force kill any stubborn processes
        pkill -9 -f "loged-server" 2>/dev/null || true
        
        # Kill any process using port 8008
        lsof -ti:8008 2>/dev/null | xargs kill -9 2>/dev/null || true
        
        echo "âœ… Loged stopped"
        ;;
    
    status)
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "âœ… Loged is running (PID: $PID)"
                echo "ğŸ“ Access at: http://localhost:8008"
            else
                echo "âŒ Loged is not running"
                rm -f "$PIDFILE"
            fi
        else
            echo "âŒ Loged is not running"
        fi
        ;;
    
    update)
        echo "ğŸ”„ Updating Loged..."
        
        # Force stop any running instances
        echo "ğŸ›‘ Stopping any running instances..."
        $0 stop
        
        # Extra cleanup - kill anything on port 8008
        lsof -ti:8008 2>/dev/null | xargs kill -9 2>/dev/null || true
        
        sleep 2
        install_and_build
        
        # Always update nginx config if on Linux
        if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v nginx &> /dev/null; then
            echo "ğŸŒ Updating nginx configuration..."
            
            # Get public IP dynamically
            PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com || echo "127.0.0.1")
            
            # Create nginx config with dynamic IP
            sed "s/SERVER_IP/$PUBLIC_IP/g" loged-nginx > /tmp/loged-nginx-configured
            sudo cp /tmp/loged-nginx-configured /etc/nginx/sites-available/loged
            rm /tmp/loged-nginx-configured
            
            if [ ! -L /etc/nginx/sites-enabled/loged ]; then
                sudo ln -s /etc/nginx/sites-available/loged /etc/nginx/sites-enabled/loged
            fi
            sudo nginx -s reload 2>/dev/null || sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Please reload nginx manually"
            echo "âœ… Nginx configuration updated"
        fi
        
        echo ""
        echo "ğŸš€ Starting updated server..."
        $0 start
        ;;
    
    ""|install)
        install_and_build
        echo ""
        echo "ğŸ‰ Installation complete!"
        echo "ğŸ“ Run 'loged start' to start the server"
        echo "ğŸ“ Run 'loged stop' to stop the server"
        ;;
    
    *)
        echo "Usage: loged {start|stop|status|install|update}"
        echo ""
        echo "Commands:"
        echo "  start   - Start Loged server in background"
        echo "  stop    - Stop Loged server"
        echo "  status  - Check if Loged is running"
        echo "  install - Install dependencies and build"
        echo "  update  - Stop, rebuild, and restart server"
        exit 1
        ;;
esac
