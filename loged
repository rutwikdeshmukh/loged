#!/bin/bash

set -e

PIDFILE="loged.pid"
LOGFILE="loged.log"

# Function to install and build
install_and_build() {
    echo "ğŸš€ Loged - Lightweight Log Viewer Setup"
    echo "======================================="

    # Check if Go is installed
    if ! command -v go &> /dev/null; then
        echo "ğŸ“¦ Installing Go..."
        
        # Detect OS and install Go
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            # Linux
            if command -v apt-get &> /dev/null; then
                sudo apt-get update -qq
                sudo apt-get install -y golang-go
            elif command -v yum &> /dev/null; then
                sudo yum install -y golang
            elif command -v dnf &> /dev/null; then
                sudo dnf install -y golang
            else
                echo "âŒ Unsupported Linux distribution. Please install Go manually."
                exit 1
            fi
        elif [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            if command -v brew &> /dev/null; then
                brew install go
            else
                echo "âŒ Please install Homebrew first or install Go manually from https://golang.org/dl/"
                exit 1
            fi
        else
            echo "âŒ Unsupported OS. Please install Go manually from https://golang.org/dl/"
            exit 1
        fi
    else
        echo "âœ… Go is already installed: $(go version)"
    fi

    # Install dependencies
    echo "ğŸ“¦ Installing dependencies..."
    go mod tidy

    # Build the application
    echo "ğŸ”¨ Building loged..."
    go build -o loged-server main.go

    # Make it executable
    chmod +x loged-server

    echo "âœ… Loged installed successfully!"
}

case "$1" in
    start)
        # Build if binary doesn't exist
        if [ ! -f "loged-server" ]; then
            install_and_build
        fi
        
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "Loged is already running (PID: $PID)"
                echo "Access at: http://localhost:8008"
                exit 1
            else
                rm -f "$PIDFILE"
            fi
        fi
        
        echo "ğŸ‰ Starting Loged server..."
        nohup ./loged-server > "$LOGFILE" 2>&1 &
        PID=$!
        echo $PID > "$PIDFILE"
        
        sleep 1
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "âœ… Loged started successfully (PID: $PID)"
            echo "ğŸ“ Server available at: http://localhost:8008"
            echo "ğŸ“„ Configuration loaded from config.yml"
        else
            echo "âŒ Failed to start Loged"
            rm -f "$PIDFILE"
            exit 1
        fi
        ;;
    
    stop)
        echo "ğŸ›‘ Stopping Loged..."
        
        # Kill by PID file first
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                kill "$PID"
                sleep 1
            fi
            rm -f "$PIDFILE"
        fi
        
        # Kill any remaining loged-server processes
        pkill -f loged-server > /dev/null 2>&1
        
        # Wait a moment for processes to terminate
        sleep 2
        
        echo "âœ… Loged stopped"
        ;;
    
    status)
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "âœ… Loged is running (PID: $PID)"
                echo "ğŸ“ Access at: http://localhost:8008"
            else
                echo "âŒ Loged is not running"
                rm -f "$PIDFILE"
            fi
        else
            echo "âŒ Loged is not running"
        fi
        ;;
    
    update)
        echo "ğŸ”„ Updating Loged..."
        
        # Stop server if running (suppress output)
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "ğŸ›‘ Stopping server..."
                $0 stop > /dev/null 2>&1
            fi
        fi
        
        sleep 1
        install_and_build
        echo ""
        echo "ğŸš€ Starting updated server..."
        $0 start
        ;;
    
    ""|install)
        install_and_build
        echo ""
        echo "ğŸ‰ Installation complete!"
        echo "ğŸ“ Run 'loged start' to start the server"
        echo "ğŸ“ Run 'loged stop' to stop the server"
        ;;
    
    *)
        echo "Usage: loged {start|stop|status|install|update}"
        echo ""
        echo "Commands:"
        echo "  start   - Start Loged server in background"
        echo "  stop    - Stop Loged server"
        echo "  status  - Check if Loged is running"
        echo "  install - Install dependencies and build"
        echo "  update  - Stop, rebuild, and restart server"
        exit 1
        ;;
esac
